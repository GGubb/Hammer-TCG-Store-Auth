<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Configurar contrase√±a</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.3'
    
    const supabaseUrl = "https://xtgzlzkiydsxciblbgqw.supabase.co"
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Z3psemtpeWRzeGNpYmxiZ3F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MzI3MzEsImV4cCI6MjA3NTIwODczMX0.xb6KZhtwxw4TS0QpBlwJSUp04278mD_JoF_odcZey48"
    const supabase = createClient(supabaseUrl, supabaseKey)

    // Helpers
    const qs = (s) => new URLSearchParams(s)

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingEl = document.getElementById('loading')
      const formEl = document.getElementById('set-password-section')
      const status = document.getElementById('status')

      loadingEl.style.display = 'block'
      formEl.style.display = 'none'
      status.textContent = ''

      try {
        const params = new URLSearchParams(window.location.search)
        const hasCode = params.has('code')
        const hasAccessToken = window.location.hash.includes('access_token')

        let sessionResult = null

        // üîπ Caso 1: Link m√°gico normal (#access_token=...)
        if (hasAccessToken && !hasCode) {
          console.log('Detectado link m√°gico normal. Procesando sesi√≥n...')
          const { data, error } = await supabase.auth.getSessionFromUrl({ storeSession: true })
          if (error) {
            console.warn('Error procesando link m√°gico:', error)
            loadingEl.innerHTML = `<div class="card"><p>Error procesando el enlace m√°gico. Intenta abrirlo de nuevo.</p></div>`
            return
          }

          console.log('Inicio de sesi√≥n exitoso, redirigiendo...')
          window.location.href = 'admin.html'
          return
        }

        // üîπ Caso 2: Invitaci√≥n / Restablecer contrase√±a (?code=...)
        else if (hasCode) {
          console.log('Detectado c√≥digo (?code=...). Intercambiando por sesi√≥n...')
          const code = params.get('code')
          sessionResult = await supabase.auth.exchangeCodeForSession(code).catch(e => {
            console.warn('exchangeCodeForSession fall√≥:', e)
            return null
          })
        }

        // 2Ô∏è‚É£ Verificar si hay sesi√≥n activa despu√©s de procesar
        const { data: { session } } = await supabase.auth.getSession()
        if (!session) {
          loadingEl.innerHTML = `
            <div class="card">
              <h2>Acceso inv√°lido o expirado</h2>
              <p>Por favor, abre el enlace m√°gico desde tu correo en la <strong>misma pesta√±a</strong> y aseg√∫rate de que la URL de redirecci√≥n en Supabase apunta a esta p√°gina.</p>
            </div>
          `
          return
        }

        // 3Ô∏è‚É£ Mostrar formulario de contrase√±a si viene del flujo de invitaci√≥n/reset
        console.log('Sesi√≥n activa detectada:', session.user.email)
        loadingEl.style.display = 'none'
        formEl.style.display = 'block'

        supabase.auth.onAuthStateChange((event) => {
          console.log('Evento auth:', event)
          if (event === 'SIGNED_OUT') {
            formEl.style.display = 'none'
            loadingEl.style.display = 'block'
            loadingEl.textContent = 'Sesi√≥n cerrada. Abre nuevamente el enlace m√°gico.'
          }
        })
      } catch (err) {
        console.error('Error al procesar la autenticaci√≥n:', err)
        loadingEl.innerHTML = `<div class="card"><p>Error al procesar el enlace. Revisa la consola.</p></div>`
      }
    })

    // üß© Cambio de contrase√±a
    window.changePassword = async () => {
      const newPassword = document.getElementById("newPassword").value
      const confirmPassword = document.getElementById("confirmPassword").value
      const status = document.getElementById("status")

      status.textContent = ''

      if (newPassword !== confirmPassword) {
        status.textContent = "Las contrase√±as no coinciden."
        return
      }
      if (newPassword.length < 6) {
        status.textContent = "La contrase√±a debe tener al menos 6 caracteres."
        return
      }

      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        status.textContent = 'Sesi√≥n no disponible. Abre el enlace m√°gico en la misma pesta√±a.'
        return
      }

      const { error } = await supabase.auth.updateUser({ password: newPassword })
      if (error) {
        console.error("Error al actualizar contrase√±a:", error)
        status.textContent = "Error al actualizar la contrase√±a. Int√©ntalo de nuevo."
      } else {
        status.textContent = "Contrase√±a actualizada correctamente. Redirigiendo..."
        setTimeout(() => window.location.href = 'admin.html', 1500)
      }
    }
  </script>

  <style>
    body { font-family: sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#f2f2f2; }
    .card { background:white; padding:2rem; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); width:320px; text-align:center; }
    input { width:100%; padding:8px; margin-top:10px; border-radius:6px; border:1px solid #ccc; }
    button { margin-top:15px; background:#0077cc; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; }
    button:hover { background:#005fa3; }
    #status { margin-top:10px; font-size:0.9em; color:#333; }
  </style>
</head>

<body>
  <div id="loading" class="card">
    <p>Procesando acceso... un momento por favor.</p>
  </div>

  <div id="set-password-section" class="card" style="display:none;">
    <h2>Establecer nueva contrase√±a</h2>
    <input type="password" id="newPassword" placeholder="Nueva contrase√±a" />
    <input type="password" id="confirmPassword" placeholder="Confirmar contrase√±a" />
    <button onclick="changePassword()">Guardar contrase√±a</button>
    <p id="status"></p>
  </div>
</body>
</html>
